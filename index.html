<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Cookifier (Browser Version)</title>
<style>
  body { font-family: system-ui, sans-serif; background: #111; color: #eee; text-align: center; padding: 2em; }
  button, input[type=file] { margin: 10px; padding: 10px 20px; border: none; border-radius: 8px; font-size: 16px; }
  button { background: #3a7; color: white; cursor: pointer; }
  button:hover { background: #4b8; }
  progress { width: 80%; margin-top: 20px; height: 20px; }
</style>
</head>
<body>
<p>Select your image and original <code>cookieclicker.zip</code></p>

<p>Image:</p><input type="file" id="imageInput" accept="image/*"><br>
<p>Cookie Clicker:</p><input type="file" id="zipInput" accept=".zip"><br>
<p>Filename (.zip):</p><input type="text" id="filenameinput"><br>
<button id="processBtn">Cookify!</button>
<br>
<progress id="progress" value="0" max="100" hidden></progress>
<p id="status"></p>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
async function imageToCanvas(imgFile) {
  const blobURL = URL.createObjectURL(imgFile);
  const img = await new Promise((res, rej) => {
    const i = new Image();
    i.onload = () => res(i);
    i.onerror = rej;
    i.src = blobURL;
  });
  const canvas = document.createElement('canvas');
  canvas.width = img.width;
  canvas.height = img.height;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0);
  URL.revokeObjectURL(blobURL);
  return canvas;
}

function resizeCanvas(source, w, h) {
  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  const ctx = c.getContext('2d');
  ctx.imageSmoothingQuality = 'high';
  ctx.drawImage(source, 0, 0, w, h);
  return c;
}

document.getElementById('processBtn').onclick = async () => {
  const imgFile = document.getElementById('imageInput').files[0];
  const zipFile = document.getElementById('zipInput').files[0];
  const progress = document.getElementById('progress');
  const status = document.getElementById('status');

  if (!imgFile || !zipFile) {
    alert("Please select both an image and a ZIP file first!");
    return;
  }

  status.textContent = "Processing...";
  progress.hidden = false;
  progress.value = 0;

  const baseCanvas = await imageToCanvas(imgFile);
  const jszip = new JSZip();
  const zipData = await jszip.loadAsync(zipFile);
  const newZip = new JSZip();
  const written = new Set();
  let processed = 0;
  const total = Object.keys(zipData.files).length;

  for (const [name, entry] of Object.entries(zipData.files)) {
    let data;
    if (entry.dir) continue;

    const ext = name.split('.').pop().toLowerCase();
    const isImage = name.startsWith("img/") && ["png","jpg","jpeg","bmp","webp"].includes(ext);

    try {
      if (isImage) {
        const blob = await entry.async("blob");
        const origImg = await createImageBitmap(blob);
        const resized = resizeCanvas(baseCanvas, origImg.width, origImg.height);
        data = await new Promise(r => resized.toBlob(r, ext === "png" ? "image/png" : "image/jpeg"));
      } else {
        data = await entry.async("blob");
      }
    } catch {
      data = await entry.async("blob");
    }

    if (!written.has(name)) {
      newZip.file(name, data);
      written.add(name);
    }

    processed++;
    progress.value = (processed / total) * 100;
  }

  // Add generated extras
  function addImg(name, w, h, gridX=1, gridY=1) {
    const c = resizeCanvas(baseCanvas, w, h);
    if (gridX > 1 || gridY > 1) {
      const g = document.createElement('canvas');
      g.width = w * gridX; g.height = h * gridY;
      const ctx = g.getContext('2d');
      for (let y = 0; y < gridY; y++)
        for (let x = 0; x < gridX; x++)
          ctx.drawImage(c, x * w, y * h);
      newZip.file(name, g.toDataURL("image/png").split(",")[1], {base64:true});
    } else {
      newZip.file(name, c.toDataURL("image/png").split(",")[1], {base64:true});
    }
  }

  addImg("img/empty.png", 256, 256);
  addImg("img/icons.png", 48, 48, 36, 37);
  addImg("img/buildings.png", 64, 64, 4, 21);
  addImg("img/storeTile.jpg", 300, 256, 1, 1);

  const result = await newZip.generateAsync({ type: "blob" });
  const url = URL.createObjectURL(result);

  const a = document.createElement('a');
  a.href = url;
  filename = document.getElementById('filenameinput').value;
  a.download = filename + ".zip";
  a.click();

  status.textContent = "Cookified ZIP ready for download!";
  progress.hidden = true;
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>
